# ğŸ” Authentication & Security Design â€” E-commerce Backend

> **Tech Stack:** NestJS Â· PostgreSQL Â· Redis Â· TypeScript Â· Docker Â· Prometheus Â· Pino Â· BullMQ

---

## ğŸ“‹ Table of Contents

1. [Overview](#-overview)
2. [Design Decisions](#-design-decisions)
3. [Database Schema](#-database-schema)
4. [Architecture & Components](#ï¸-architecture--components)
5. [Security Specifications](#-security-specifications)
6. [Email Infrastructure](#-email-infrastructure)
7. [Rate Limiting](#-rate-limiting)
8. [Implementation Plan](#-implementation-plan)
9. [Integration Points](#-integration-points)
10. [Testing Strategy](#-testing-strategy)
11. [Future Extensions](#-future-extensions)

---

## ğŸ§­ Overview

This document defines the **authentication and security strategy** for our production-grade **E-commerce backend**. The system follows **enterprise-level security practices** and integrates seamlessly into the NestJS modular architecture, supporting **scalability**, **observability**, and **maintainability** from day one.

### ğŸ¯ Goals

- âœ… **Security-First**: Industry-standard practices (JWT + Refresh Tokens, bcrypt, rate limiting)
- âœ… **Developer-Friendly**: Clear patterns, modular structure, comprehensive documentation
- âœ… **Production-Ready**: Observability (Prometheus), logging (Pino), error handling
- âœ… **Scalable**: Stateless design, Redis-backed, distributed rate limiting

---

## ğŸ¨ Design Decisions

### âš™ï¸ Authentication Type

**JWT-based Authentication with Refresh Tokens** â€” the industry standard for stateless APIs.

#### Why JWT?

| Aspect | Benefit |
|--------|---------|
| ğŸ” **Stateless** | No server-side session storage required |
| ğŸ“ˆ **Scalable** | Works across multiple server instances |
| ğŸ” **Secure** | Refresh token rotation prevents token reuse attacks |
| ğŸ§© **Compatible** | Perfect for microservices and frontend clients |

### ğŸ”‘ Token Strategy

| Token Type | Storage Location | Expiry | Purpose | Security |
|------------|------------------|--------|---------|----------|
| **Access Token** | In-memory / HTTP Header (`Authorization: Bearer <token>`) | 15mâ€“1h | Authenticate API requests | Short-lived, stateless |
| **Refresh Token** | HttpOnly Cookie (secure, sameSite) | 7â€“30 days | Obtain new access tokens | Rotated on each use, stored hashed in DB |

### ğŸ”’ Refresh Token Security Decision

**âœ… Store HMAC-SHA256 hash of refresh tokens** (not plaintext)

**Rationale:**
- âš¡ **Fast**: HMAC is O(1) and adds negligible latency (< 1ms per refresh)
- ğŸ” **Secure**: If DB leaks, attackers only get hashes (not usable tokens)
- ğŸ¯ **Best Practice**: Industry standard for token storage

**Implementation:**
```typescript
// Hash token before storing
const tokenHash = crypto.createHmac('sha256', HMAC_SECRET)
  .update(refreshToken)
  .digest('hex');

// Lookup by hash
const storedHash = crypto.createHmac('sha256', HMAC_SECRET)
  .update(presentedToken)
  .digest('hex');
```

**Performance Note:** HMAC is cheap; Argon2 would add CPU cost to every refresh request.

---

## ğŸ§± Database Schema

### Prisma Models

```prisma
model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String   // Hashed with bcrypt (12 rounds)
  name           String?
  role           UserRole @default(CUSTOMER)
  isEmailVerified Boolean @default(false)
  refreshTokens  RefreshToken[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique // HMAC-SHA256 hash of token
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt]) // For cleanup of expired tokens
  @@map("refresh_tokens")
}

enum UserRole {
  CUSTOMER
  ADMIN
  MANAGER // Future: inventory/order management
}
```

### ğŸ”„ Schema Changes Required

1. **Update User model**:
   - Add `isEmailVerified` field
   - Update role to enum (`UserRole`)
   - Rename `isVerified` â†’ `isEmailVerified` (clearer naming)

2. **Update RefreshToken model**:
   - Rename `token` â†’ `tokenHash` (stores HMAC hash, not plaintext)
   - Add indexes for performance

3. **Migration**: Create migration to update existing schema (if any)

---

## ğŸ—ï¸ Architecture & Components

### ğŸ“ Module Structure

```
/src
 â”œâ”€â”€ modules
 â”‚    â””â”€â”€ auth
 â”‚         â”œâ”€â”€ auth.module.ts              # Root auth module
 â”‚         â”œâ”€â”€ auth.controller.ts          # HTTP endpoints
 â”‚         â”œâ”€â”€ auth.service.ts             # Business logic
 â”‚         â”‚
 â”‚         â”œâ”€â”€ strategies/
 â”‚         â”‚    â”œâ”€â”€ jwt.strategy.ts        # Access token validation
 â”‚         â”‚    â””â”€â”€ refresh.strategy.ts    # Refresh token validation
 â”‚         â”‚
 â”‚         â”œâ”€â”€ guards/
 â”‚         â”‚    â”œâ”€â”€ jwt-auth.guard.ts      # Protect routes (use access token)
 â”‚         â”‚    â””â”€â”€ roles.guard.ts         # RBAC enforcement
 â”‚         â”‚
 â”‚         â”œâ”€â”€ decorators/
 â”‚         â”‚    â”œâ”€â”€ public.decorator.ts    # Mark routes as public
 â”‚         â”‚    â”œâ”€â”€ roles.decorator.ts     # Specify required roles
 â”‚         â”‚    â””â”€â”€ current-user.decorator.ts  # Extract user from request
 â”‚         â”‚
 â”‚         â”œâ”€â”€ dto/
 â”‚         â”‚    â”œâ”€â”€ register.dto.ts        # Registration request
 â”‚         â”‚    â”œâ”€â”€ login.dto.ts           # Login request
 â”‚         â”‚    â”œâ”€â”€ refresh.dto.ts         # Refresh request (no body, uses cookie)
 â”‚         â”‚    â”œâ”€â”€ verify-email.dto.ts    # Email verification request
 â”‚         â”‚    â””â”€â”€ password-reset.dto.ts  # Password reset request
 â”‚         â”‚
 â”‚         â”œâ”€â”€ interfaces/
 â”‚         â”‚    â”œâ”€â”€ jwt-payload.interface.ts
 â”‚         â”‚    â””â”€â”€ token-pair.interface.ts
 â”‚         â”‚
 â”‚         â””â”€â”€ utils/
 â”‚              â””â”€â”€ token.util.ts          # Token generation & validation helpers
 â”‚
 â”œâ”€â”€ modules
 â”‚    â””â”€â”€ mailer                            # NEW: Email infrastructure module
 â”‚         â”œâ”€â”€ mailer.module.ts
 â”‚         â”œâ”€â”€ mailer.service.ts
 â”‚         â”œâ”€â”€ templates/
 â”‚         â”‚    â”œâ”€â”€ verification.hbs
 â”‚         â”‚    â”œâ”€â”€ password-reset.hbs
 â”‚         â”‚    â””â”€â”€ welcome.hbs
 â”‚         â””â”€â”€ processors/
 â”‚              â””â”€â”€ mail.processor.ts      # BullMQ worker for async email sending
 â”‚
 â””â”€â”€ common
      â””â”€â”€ rate-limiting/
           â”œâ”€â”€ rate-limit.module.ts        # NEW: Rate limiting module
           â”œâ”€â”€ rate-limit.guard.ts         # Rate limiting guard
           â””â”€â”€ rate-limit.service.ts       # Redis-backed rate limiting
```

### ğŸ”§ Key Components

| Component | Responsibility | Dependencies |
|-----------|---------------|--------------|
| **AuthService** | Registration, login, token generation, password hashing | PrismaService, JwtService, MailerService |
| **JwtStrategy** | Validates access token on each authenticated request | Passport, JWT |
| **RefreshStrategy** | Validates refresh token, handles rotation | Passport, PrismaService |
| **JwtAuthGuard** | Protects routes, extracts user from JWT | JwtStrategy |
| **RolesGuard** | Enforces role-based access control | Reflector, JwtAuthGuard |
| **MailerService** | Sends transactional emails (verification, password reset) | BullMQ, Handlebars |
| **RateLimitGuard** | Enforces rate limits on endpoints | Redis, rate-limiter-flexible |

---

## ğŸ” Security Specifications

### ğŸ”’ Password Security

| Aspect | Specification |
|--------|--------------|
| **Hashing Algorithm** | `bcrypt` (12â€“14 rounds) |
| **Salt** | Automatic (bcrypt handles salting) |
| **Validation** | Minimum 8 characters, complexity recommended (but not enforced) |
| **Reset Flow** | Signed JWT token, 1-hour expiry, single-use |

### ğŸ« Token Security

| Token Type | Algorithm | Secret | Expiry | Rotation |
|------------|-----------|--------|--------|----------|
| **Access Token** | HS256 | `JWT_SECRET` (env var) | 15mâ€“1h (configurable) | No |
| **Refresh Token** | Random UUID | N/A | 7â€“30 days (configurable) | âœ… Yes (on each refresh) |
| **Email Verification** | Signed JWT | `JWT_SECRET` | 24 hours | No |
| **Password Reset** | Signed JWT | `JWT_SECRET` | 1 hour | Single-use |

### ğŸ›¡ï¸ API Security

| Layer | Implementation |
|-------|----------------|
| **Rate Limiting** | Redis-backed, per-IP and per-user (see [Rate Limiting](#-rate-limiting)) |
| **Route Protection** | `@UseGuards(JwtAuthGuard)` by default, `@Public()` for public routes |
| **CSRF Protection** | SameSite cookies + state tokens for sensitive operations |
| **Input Validation** | `class-validator` DTOs, automatic validation via `ValidationPipe` |
| **SQL Injection** | Prisma ORM (parameterized queries) |
| **XSS Protection** | Input sanitization + secure headers |

### ğŸ§¾ Transport Security

- âœ… **HTTPS Only** (in production, enforced via reverse proxy/LB)
- âœ… **Secure Cookies**: `httpOnly: true`, `secure: true` (production), `sameSite: 'strict'`
- âœ… **Security Headers**: Helmet.js middleware (future addition)

### ğŸ•µï¸ Logging & Monitoring

| Component | Tool | Purpose |
|-----------|------|---------|
| **Structured Logging** | **Pino** (not Winston) | Auth events, failures, token reuse attempts |
| **Metrics** | **Prometheus** | Login attempts, failed logins, token refresh counts, rate limit blocks |
| **Request Tracing** | Request ID middleware | Track auth flows across services |

**Why Pino?** Faster, lower latency, better for high-throughput e-commerce workloads. Structured JSON logs work seamlessly with observability pipelines.

---

## ğŸ“§ Email Infrastructure

### ğŸ¯ Purpose

Email infrastructure serves **both auth and transactional** use cases:
- **Auth**: Email verification, password reset, security alerts
- **Transactional**: Order confirmations, shipping notifications (future)

### ğŸ—ï¸ Architecture

**Single reusable mailer module** used across the application.

```
MailerModule
  â”œâ”€â”€ MailerService (synchronous interface)
  â”œâ”€â”€ BullMQ Queue (async processing)
  â”œâ”€â”€ MailProcessor (worker, handles retries)
  â”œâ”€â”€ Template Engine (Handlebars)
  â””â”€â”€ Provider Abstraction (Ethereal/MailHog/SendGrid)
```

### ğŸ“‹ Email Types (MVP)

| Email Type | Trigger | Template | Queue Priority |
|------------|---------|----------|----------------|
| **Verification** | User registration | `verification.hbs` | High |
| **Password Reset** | User requests reset | `password-reset.hbs` | High |
| **Welcome** | Email verified | `welcome.hbs` | Normal |
| **Security Alert** | Password changed, suspicious login | `security-alert.hbs` | High |

### ğŸ”§ Provider Strategy

| Environment | Provider | Configuration | Reason |
|-------------|----------|---------------|--------|
| **Development** | Ethereal / MailHog | Local SMTP | Fast feedback, zero cost, no deliverability concerns |
| **Staging/Production** | SendGrid / Postmark / Mailgun | API key | Good deliverability, webhooks, free/low-tier available |

### âš™ï¸ Environment Variables

```bash
# Mailer Configuration
MAILER_DRIVER=ethereal  # ethereal | smtp | sendgrid | postmark | ses
SMTP_HOST=localhost
SMTP_PORT=1025
SMTP_USER=
SMTP_PASS=

# Provider-specific (example for SendGrid)
SENDGRID_API_KEY=

# Email Settings
FROM_EMAIL="no-reply@yourdomain.com"
FROM_NAME="YourShop"

# Queue (reuses Redis)
BULLMQ_REDIS_URL="redis://localhost:6379"
```

### ğŸ“¦ Required Dependencies

```json
{
  "dependencies": {
    "@nestjs/bullmq": "^10.0.1",  // Already installed
    "bullmq": "^5.3.0",            // Already installed
    "handlebars": "^4.7.8",        // Template engine
    "nodemailer": "^6.9.7",        // SMTP client
    "@sendgrid/mail": "^7.7.0"     // Optional: SendGrid provider
  }
}
```

### ğŸ” Email Security

- **Signed Tokens**: Verification/reset tokens are signed JWTs (not guessable)
- **Short Expiry**: Verification (24h), Password Reset (1h)
- **Rate Limiting**: Limit email send requests (see [Rate Limiting](#-rate-limiting))
- **Single-Use**: Password reset tokens invalidated after use

---

## â±ï¸ Rate Limiting

### ğŸ“Š Rate Limits (Default Values)

| Endpoint | Limit | Window | Key | Action on Exceed |
|----------|-------|--------|-----|------------------|
| **Login** | 5 requests | 1 minute | IP + Email | Return 429, block 15 minutes |
| **Refresh** | 30 requests | 1 minute | IP + Token | Return 429 |
| **Register** | 3 requests | 1 hour | IP | Return 429 |
| **Password Reset** | 3 requests | 1 hour | IP + Email | Return 429 |
| **Email Verification** | 5 requests | 1 hour | IP + Email | Return 429 |
| **General API** | 100 requests | 1 minute | IP | Return 429 |

### âš™ï¸ Configuration

**Environment Variables:**

```bash
# Rate Limiting (Redis-backed)
RATE_LIMIT_LOGIN_PER_MIN=5
RATE_LIMIT_REFRESH_PER_MIN=30
RATE_LIMIT_REGISTER_PER_HR=3
RATE_LIMIT_PASSWORD_RESET_PER_HR=3
RATE_LIMIT_EMAIL_VERIFY_PER_HR=5
RATE_LIMIT_GENERAL_PER_MIN=100
RATE_LIMIT_REDIS_URL=redis://localhost:6379  # Optional: separate Redis instance
```

**Implementation:** Use `rate-limiter-flexible` package (Redis-backed, distributed, supports sliding window).

### ğŸ“¦ Required Dependencies

```json
{
  "dependencies": {
    "rate-limiter-flexible": "^5.0.3"
  },
  "devDependencies": {
    "@types/rate-limiter-flexible": "^2.0.4"
  }
}
```

---

## ğŸš€ Implementation Plan

### ğŸ“‹ Prerequisites

Before starting implementation, ensure:
- âœ… Prisma schema is updated with User and RefreshToken models
- âœ… Redis is running and accessible
- âœ… Environment variables are configured (see `env.example`)
- âœ… Dependencies are installed (JWT, Passport, bcrypt, etc.)

---

### ğŸ¯ Phase 1: Core Infrastructure (Foundation)

**Goal:** Set up database, basic services, and utilities.

#### 1.1 Database Schema & Migration
- [ ] Update Prisma schema with User and RefreshToken models
- [ ] Add indexes for performance (userId, tokenHash, expiresAt)
- [ ] Create and run migration
- [ ] Update seed script to include sample users (optional)

**Files to create/modify:**
- `prisma/schema.prisma`
- `prisma/migrations/*`

#### 1.2 Token Utilities
- [ ] Create `auth/utils/token.util.ts` with:
  - `generateAccessToken()` - JWT generation
  - `generateRefreshToken()` - UUID generation
  - `hashRefreshToken()` - HMAC-SHA256 hashing
  - `verifyRefreshToken()` - Hash comparison

**Files to create:**
- `src/modules/auth/utils/token.util.ts`

#### 1.3 Interfaces & Types
- [ ] Create `auth/interfaces/jwt-payload.interface.ts`
- [ ] Create `auth/interfaces/token-pair.interface.ts`
- [ ] Create `auth/interfaces/refresh-token-payload.interface.ts`

**Files to create:**
- `src/modules/auth/interfaces/jwt-payload.interface.ts`
- `src/modules/auth/interfaces/token-pair.interface.ts`
- `src/modules/auth/interfaces/refresh-token-payload.interface.ts`

---

### ğŸ¯ Phase 2: Authentication Core (MVP)

**Goal:** Implement registration, login, and token refresh flows.

#### 2.1 DTOs & Validation
- [ ] Create `dto/register.dto.ts` (email, password, name)
- [ ] Create `dto/login.dto.ts` (email, password)
- [ ] Create `dto/refresh.dto.ts` (optional: no body, uses cookie)
- [ ] Add validation decorators (`@IsEmail()`, `@MinLength()`, etc.)

**Files to create:**
- `src/modules/auth/dto/register.dto.ts`
- `src/modules/auth/dto/login.dto.ts`
- `src/modules/auth/dto/refresh.dto.ts`

#### 2.2 Auth Service (Business Logic)
- [ ] Implement `register()` - hash password, create user, return tokens
- [ ] Implement `login()` - validate credentials, generate tokens
- [ ] Implement `refresh()` - validate refresh token, rotate, return new access token
- [ ] Implement `logout()` - invalidate refresh token
- [ ] Implement `validateUser()` - used by Passport strategies

**Files to create:**
- `src/modules/auth/auth.service.ts`

#### 2.3 Passport Strategies
- [ ] Create `strategies/jwt.strategy.ts` - validates access token
- [ ] Create `strategies/refresh.strategy.ts` - validates refresh token from cookie

**Files to create:**
- `src/modules/auth/strategies/jwt.strategy.ts`
- `src/modules/auth/strategies/refresh.strategy.ts`

#### 2.4 Guards & Decorators
- [ ] Create `guards/jwt-auth.guard.ts` - protects routes
- [ ] Create `guards/roles.guard.ts` - enforces RBAC
- [ ] Create `decorators/public.decorator.ts` - marks public routes
- [ ] Create `decorators/roles.decorator.ts` - specifies required roles
- [ ] Create `decorators/current-user.decorator.ts` - extracts user from request

**Files to create:**
- `src/modules/auth/guards/jwt-auth.guard.ts`
- `src/modules/auth/guards/roles.guard.ts`
- `src/modules/auth/decorators/public.decorator.ts`
- `src/modules/auth/decorators/roles.decorator.ts`
- `src/modules/auth/decorators/current-user.decorator.ts`

#### 2.5 Controller & Routes
- [ ] Create `auth.controller.ts` with endpoints:
  - `POST /auth/register` - Public
  - `POST /auth/login` - Public
  - `POST /auth/refresh` - Public (uses cookie)
  - `POST /auth/logout` - Protected
  - `GET /auth/me` - Protected (returns current user)

**Files to create:**
- `src/modules/auth/auth.controller.ts`

#### 2.6 Module Configuration
- [ ] Update `auth.module.ts` - import JwtModule, configure strategies, export guards

**Files to modify:**
- `src/modules/auth/auth.module.ts`

#### 2.7 Environment Variables
- [ ] Add to `env.example`:
  - `JWT_SECRET`
  - `JWT_EXPIRES_IN`
  - `JWT_REFRESH_EXPIRES_IN`
  - `HMAC_SECRET` (for refresh token hashing)

**Files to modify:**
- `env.example`


---

### ğŸ¯ Phase 3: Email Infrastructure

**Goal:** Set up email sending for verification and password reset.

#### 3.1 Mailer Module Setup
- [ ] Install dependencies: `nodemailer`, `handlebars`, `@sendgrid/mail` (optional)
- [ ] Create `modules/mailer/mailer.module.ts`
- [ ] Create `modules/mailer/mailer.service.ts` with provider abstraction
- [ ] Implement Ethereal provider (dev)
- [ ] Implement SendGrid provider (staging/prod)

**Files to create:**
- `src/modules/mailer/mailer.module.ts`
- `src/modules/mailer/mailer.service.ts`
- `src/modules/mailer/providers/ethereal.provider.ts`
- `src/modules/mailer/providers/sendgrid.provider.ts`

#### 3.2 BullMQ Integration
- [ ] Create `modules/mailer/processors/mail.processor.ts`
- [ ] Configure BullMQ queue for email jobs
- [ ] Implement retry logic and error handling

**Files to create:**
- `src/modules/mailer/processors/mail.processor.ts`
- `src/modules/mailer/queues/mail.queue.ts`

#### 3.3 Email Templates
- [ ] Create Handlebars templates:
  - `templates/verification.hbs` - Email verification
  - `templates/password-reset.hbs` - Password reset
  - `templates/welcome.hbs` - Welcome email

**Files to create:**
- `src/modules/mailer/templates/verification.hbs`
- `src/modules/mailer/templates/password-reset.hbs`
- `src/modules/mailer/templates/welcome.hbs`

#### 3.4 Environment Variables
- [ ] Add mailer config to `env.example`

**Files to modify:**
- `env.example`


---

### ğŸ¯ Phase 4: Email Verification & Password Reset

**Goal:** Complete auth flows with email verification and password reset.

#### 4.1 Email Verification Flow
- [ ] Update `register()` - set `isEmailVerified = false`, generate verification token
- [ ] Add `sendVerificationEmail()` to AuthService
- [ ] Create `POST /auth/verify` endpoint - validates token, sets `isEmailVerified = true`
- [ ] Create `POST /auth/resend-verification` endpoint - resends verification email

**Files to modify:**
- `src/modules/auth/auth.service.ts`
- `src/modules/auth/auth.controller.ts`

**Files to create:**
- `src/modules/auth/dto/verify-email.dto.ts`

#### 4.2 Password Reset Flow
- [ ] Create `POST /auth/forgot-password` endpoint - generates reset token, sends email
- [ ] Create `POST /auth/reset-password` endpoint - validates token, updates password
- [ ] Implement token invalidation (single-use)

**Files to modify:**
- `src/modules/auth/auth.service.ts`
- `src/modules/auth/auth.controller.ts`

**Files to create:**
- `src/modules/auth/dto/password-reset.dto.ts`


---

### ğŸ¯ Phase 5: Rate Limiting

**Goal:** Protect endpoints from abuse and brute-force attacks.

#### 5.1 Rate Limiting Module
- [ ] Install `rate-limiter-flexible`
- [ ] Create `common/rate-limiting/rate-limit.module.ts`
- [ ] Create `common/rate-limiting/rate-limit.service.ts`
- [ ] Implement Redis-backed rate limiters for each endpoint type

**Files to create:**
- `src/common/rate-limiting/rate-limit.module.ts`
- `src/common/rate-limiting/rate-limit.service.ts`
- `src/common/rate-limiting/rate-limit.guard.ts`

#### 5.2 Apply Rate Limits
- [ ] Create decorator `@RateLimit()` for flexible application
- [ ] Apply rate limits to:
  - `/auth/login` - 5/min
  - `/auth/register` - 3/hour
  - `/auth/refresh` - 30/min
  - `/auth/forgot-password` - 3/hour
  - `/auth/resend-verification` - 5/hour

**Files to create:**
- `src/common/rate-limiting/decorators/rate-limit.decorator.ts`

**Files to modify:**
- `src/modules/auth/auth.controller.ts`

#### 5.3 Environment Variables
- [ ] Add rate limit config to `env.example`

**Files to modify:**
- `env.example`


---

### ğŸ¯ Phase 6: Observability & Monitoring

**Goal:** Add metrics and logging for auth operations.

#### 6.1 Prometheus Metrics
- [ ] Add auth-specific metrics to PrometheusService:
  - `auth_login_attempts_total` (counter)
  - `auth_login_failures_total` (counter)
  - `auth_token_refreshes_total` (counter)
  - `auth_registrations_total` (counter)
  - `rate_limit_blocks_total` (counter)

**Files to modify:**
- `src/common/prometheus/prometheus.service.ts`

#### 6.2 Structured Logging
- [ ] Add Pino logging in AuthService for:
  - Login attempts (success/failure)
  - Token refresh events
  - Token reuse detection (security alert)
  - Registration events

**Files to modify:**
- `src/modules/auth/auth.service.ts`

#### 6.3 Error Handling
- [ ] Create custom exceptions:
  - `InvalidCredentialsException`
  - `TokenExpiredException`
  - `TokenReusedException` (security alert)
  - `EmailNotVerifiedException`

**Files to create:**
- `src/modules/auth/exceptions/auth.exceptions.ts`


---

### ğŸ¯ Phase 7: Testing & Validation

**Goal:** Ensure reliability and security through comprehensive testing.

#### 7.1 Unit Tests
- [ ] Test AuthService methods (register, login, refresh, logout)
- [ ] Test token utilities (hashing, generation)
- [ ] Test guards and decorators

**Files to create:**
- `src/modules/auth/auth.service.spec.ts`
- `src/modules/auth/utils/token.util.spec.ts`
- `src/modules/auth/guards/jwt-auth.guard.spec.ts`

#### 7.2 Integration Tests
- [ ] Test registration flow end-to-end
- [ ] Test login flow with invalid credentials
- [ ] Test token refresh and rotation
- [ ] Test email verification flow

**Files to create:**
- `test/auth.e2e-spec.ts`

#### 7.3 Security Tests
- [ ] Test refresh token reuse detection (revokes all sessions)
- [ ] Test rate limiting blocks excessive requests
- [ ] Test password reset token single-use enforcement
- [ ] Test expired token rejection

#### 7.4 Load Testing
- [ ] k6 script for `/auth/refresh` endpoint (validate HMAC performance)
- [ ] k6 script for `/auth/login` endpoint (validate rate limiting)
- [ ] Monitor metrics during load tests

**Files to create:**
- `k6/auth-test.js`


---

### ğŸ¯ Phase 8: Documentation & Cleanup

**Goal:** Document implementation and prepare for production.

#### 8.1 API Documentation
- [ ] Update Postman collection with auth endpoints
- [ ] Document request/response formats
- [ ] Add example curl commands

**Files to modify:**
- `docs/Ecom-Dev-Collection.postman_collection.json`

#### 8.2 Code Documentation
- [ ] Add JSDoc comments to all public methods
- [ ] Document security considerations
- [ ] Add inline comments for complex logic

#### 8.3 README Updates
- [ ] Update README with auth setup instructions
- [ ] Document environment variables
- [ ] Add troubleshooting section

**Files to modify:**
- `README.md`


---

## ğŸ§© Integration Points

| Component | Integration Method | Purpose |
|-----------|-------------------|---------|
| **Prisma** | `PrismaService` (global) | User and RefreshToken data access |
| **Redis** | `RedisService` (global) | Rate limiting, token blacklist (future) |
| **Prometheus** | `PrometheusService` (global) | Auth metrics (login attempts, failures) |
| **Pino Logger** | `Logger` (global) | Structured logging of auth events |
| **BullMQ** | Queue module | Async email sending |
| **JWT Module** | `JwtModule` (imported in AuthModule) | Token signing and verification |

---

## ğŸ§ª Testing Strategy

### âœ… Unit Tests

Test individual components in isolation:
- AuthService business logic
- Token utilities (hashing, generation)
- Guards and decorators
- DTO validation

### âœ… Integration Tests

Test complete flows:
- Registration â†’ Email Verification â†’ Login
- Login â†’ Token Refresh â†’ Logout
- Password Reset Flow

### âœ… Security Tests

Validate security controls:
- Refresh token reuse detection
- Rate limiting effectiveness
- Token expiration handling
- Password reset token single-use

### âœ… Load Tests

Performance validation:
- `/auth/refresh` endpoint under load (HMAC performance)
- Rate limiting under high request volume
- Database query performance for token lookups

**Tool:** k6 scripts in `k6/` directory

---

## ğŸš€ Future Extensions

| Feature | Priority | Estimated Complexity |
|---------|----------|---------------------|
| ğŸ”„ **OAuth2 (Google, GitHub)** | Medium | Medium (4-6 hours) |
| ğŸ“¬ **Magic Link / Passwordless Login** | Low | Medium (3-4 hours) |
| ğŸ§ **Two-Factor Authentication (2FA)** | Medium | High (8-10 hours) |
| ğŸ” **User Activity Logs & Session Analytics** | Low | Medium (4-5 hours) |
| ğŸ” **Token Blacklist (Redis)** | Low | Low (2-3 hours) |
| ğŸŒ **Multi-device Session Management** | Low | Medium (4-5 hours) |

---

## ğŸ“Š Summary

| Aspect | Implementation | Status |
|--------|---------------|--------|
| **Authentication** | JWT + Refresh Tokens | â³ Planned |
| **Password Security** | bcrypt (12 rounds) | â³ Planned |
| **Token Security** | HMAC-SHA256 hashing | â³ Planned |
| **Email Infrastructure** | Mailer module + BullMQ | â³ Planned |
| **Rate Limiting** | Redis-backed (rate-limiter-flexible) | â³ Planned |
| **Observability** | Prometheus + Pino | â³ Planned |
| **Testing** | Unit + Integration + Security | â³ Planned |

---

**Last Updated:** Implementation progress tracked below.

---

## ğŸ“Š Implementation Status

This section tracks the current implementation progress for each phase defined in the [Implementation Plan](#-implementation-plan).

### âœ… Phase Status Overview

| Phase | Status | Completion |
|-------|--------|------------|
| **Phase 1: Core Infrastructure** | âœ… Complete | 100% |
| **Phase 2: Authentication Core** | âœ… Complete | 100% |
| **Phase 3: Email Infrastructure** | âœ… Complete | 100% |
| **Phase 4: Email Verification & Password Reset** | â³ Pending | 0% |
| **Phase 5: Rate Limiting** | â³ Pending | 0% |
| **Phase 6: Observability & Monitoring** | â³ Pending | 0% |
| **Phase 7: Testing & Validation** | â³ Pending | 0% |
| **Phase 8: Documentation & Cleanup** | â³ Pending | 0% |

---

## âœ… Phase 1: Core Infrastructure

### 1.1 Database Schema & Migration
- âœ… Prisma schema updated with `User` and `RefreshToken` models
- âœ… Indexes added for performance (`userId`, `tokenHash`, `expiresAt`)
- âœ… Migration created and ready

### 1.2 Token Utilities
- âœ… Created `src/modules/auth/utils/token.util.ts` with:
  - `generateAccessToken()` - JWT generation
  - `generateRefreshToken()` - UUID generation
  - `hashRefreshToken()` - HMAC-SHA256 hashing
  - `verifyRefreshToken()` - Hash comparison

### 1.3 Interfaces & Types
- âœ… Created `src/modules/auth/interfaces/jwt-payload.interface.ts`
- âœ… Created `src/modules/auth/interfaces/token-pair.interface.ts`
- âœ… Created `src/modules/auth/interfaces/refresh-token-payload.interface.ts`

---

## âœ… Phase 2: Authentication Core (MVP)

### 2.1 DTOs & Validation
- âœ… `dto/register.dto.ts` - Email, password (min 8 chars), optional name
- âœ… `dto/login.dto.ts` - Email and password validation
- âœ… `dto/refresh.dto.ts` - Placeholder for refresh requests (uses cookie)
- âœ… All DTOs use `class-validator` decorators for automatic validation

### 2.2 Auth Service
- âœ… **File:** `src/modules/auth/auth.service.ts`

**Implemented Methods:**
- `register()` - User registration with password hashing
- `login()` - Credential validation and token generation
- `refresh()` - Token refresh with rotation
- `logout()` - Token invalidation
- `validateUser()` - For Passport strategies

**Security Features:**
- âœ… Bcrypt password hashing (12 rounds)
- âœ… HMAC-SHA256 refresh token hashing
- âœ… Token rotation on refresh
- âœ… Generic error messages to prevent enumeration

### 2.3 Passport Strategies
- âœ… `strategies/jwt.strategy.ts` - Validates JWT access tokens from `Authorization` header
- âœ… `strategies/refresh.strategy.ts` - Validates refresh tokens from cookies (for future use)

### 2.4 Guards & Decorators
**Guards:**
- âœ… `guards/jwt-auth.guard.ts` - Protects routes, checks `@Public()` decorator
- âœ… `guards/roles.guard.ts` - Enforces RBAC based on `@Roles()` decorator

**Decorators:**
- âœ… `decorators/public.decorator.ts` - Marks routes as public
- âœ… `decorators/roles.decorator.ts` - Specifies required roles
- âœ… `decorators/current-user.decorator.ts` - Extracts user from request

### 2.5 Controller & Routes
- âœ… **File:** `src/modules/auth/auth.controller.ts`

**Endpoints Implemented:**
| Endpoint | Method | Access | Description |
|----------|--------|--------|-------------|
| `/auth/register` | POST | Public | Registers user, returns tokens |
| `/auth/login` | POST | Public | Authenticates user, returns tokens |
| `/auth/refresh` | POST | Public | Refreshes access token, rotates refresh token |
| `/auth/logout` | POST | Protected | Invalidates refresh token |
| `/auth/me` | GET | Protected | Returns current user profile |

**Security Features:**
- âœ… HttpOnly cookies for refresh tokens
- âœ… Secure cookies in production
- âœ… SameSite: strict to prevent CSRF

### 2.6 Module Configuration
- âœ… `auth.module.ts` configured with:
  - JwtModule with dynamic secrets
  - Passport strategies registered
  - Guards exported for use in other modules
  - Integration with global services (Prisma, Config, Logger)

### 2.7 Environment Variables
- âœ… Updated `env.example` with:
  - `JWT_SECRET`
  - `JWT_EXPIRES_IN`
  - `JWT_REFRESH_EXPIRES_IN`
  - `HMAC_SECRET` (for refresh token hashing)

### ğŸ“ File Structure (Phase 2)

```
src/modules/auth/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ register.dto.ts
â”‚   â”œâ”€â”€ login.dto.ts
â”‚   â””â”€â”€ refresh.dto.ts
â”œâ”€â”€ strategies/
â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â””â”€â”€ refresh.strategy.ts
â”œâ”€â”€ guards/
â”‚   â”œâ”€â”€ jwt-auth.guard.ts
â”‚   â””â”€â”€ roles.guard.ts
â”œâ”€â”€ decorators/
â”‚   â”œâ”€â”€ public.decorator.ts
â”‚   â”œâ”€â”€ roles.decorator.ts
â”‚   â””â”€â”€ current-user.decorator.ts
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ jwt-payload.interface.ts
â”‚   â”œâ”€â”€ token-pair.interface.ts
â”‚   â””â”€â”€ refresh-token-payload.interface.ts
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ token.util.ts
â”œâ”€â”€ auth.controller.ts
â”œâ”€â”€ auth.service.ts
â””â”€â”€ auth.module.ts
```

### âœ… Build Status
- âœ… TypeScript compilation: **Success**
- âœ… No linter errors
- âœ… All dependencies resolved

### âœ¨ Key Features Implemented

**Security Practices:**
- âœ… Password hashing with bcrypt (12 rounds)
- âœ… Refresh token hashing with HMAC-SHA256
- âœ… Token rotation on refresh
- âœ… HttpOnly cookies
- âœ… Generic error messages

**Developer Experience:**
- âœ… Clear comments explaining purpose and reasoning
- âœ… Type-safe interfaces
- âœ… Consistent error handling
- âœ… Modular architecture

**Production Readiness:**
- âœ… Environment-based configuration
- âœ… Structured logging
- âœ… Error handling
- âœ… Scalable design

---

## âœ… Phase 3: Email Infrastructure

### 3.1 Dependencies Installed
- âœ… `nodemailer` - SMTP client
- âœ… `handlebars` - Template engine
- âœ… `@types/nodemailer` - TypeScript types

### 3.2 Email Providers
- âœ… **File:** `src/modules/mailer/providers/`

**Providers Implemented:**
| Provider | File | Purpose |
|----------|------|---------|
| **Ethereal** | `ethereal.provider.ts` | Development provider (captures emails, no real sending) |
| **SMTP** | `smtp.provider.ts` | Production provider (sends via SMTP) |

**Features:**
- âœ… Provider abstraction interface (`IMailProvider`)
- âœ… Easy switching via `MAILER_DRIVER` env var
- âœ… Provider verification on startup

### 3.3 Email Templates
- âœ… **Directory:** `src/modules/mailer/templates/`

**Templates Implemented:**
- âœ… `verification.hbs` - Email verification template
- âœ… `password-reset.hbs` - Password reset template
- âœ… `welcome.hbs` - Welcome email template

**Template Features:**
- âœ… Responsive HTML design
- âœ… Handlebars templating with variables
- âœ… Common variables (appName, appUrl, year)

### 3.4 Mailer Service
- âœ… **File:** `src/modules/mailer/mailer.service.ts`

**Features:**
- âœ… Template rendering with Handlebars
- âœ… Async email queuing via BullMQ
- âœ… Synchronous sending option
- âœ… Provider abstraction

**Methods:**
- `queueEmail()` - Queue email for async processing (recommended)
- `sendEmail()` - Send email immediately (use sparingly)
- `sendMailDirectly()` - Direct provider access (for processor)

### 3.5 BullMQ Integration
- âœ… **File:** `src/modules/mailer/processors/mail.processor.ts`

**Features:**
- âœ… Automatic retries (up to 3 attempts)
- âœ… Exponential backoff
- âœ… Concurrent processing (5 emails at once)
- âœ… Rate limiting (10 emails/second)
- âœ… Job cleanup (completed/failed jobs)

### 3.6 Mailer Module
- âœ… **File:** `src/modules/mailer/mailer.module.ts`

**Configuration:**
- âœ… BullMQ queue configuration
- âœ… Redis connection setup
- âœ… Provider initialization
- âœ… Module verification on startup

### 3.7 Environment Configuration
- âœ… Updated `env.example` with:
  - `MAILER_DRIVER` - Provider selection (ethereal/smtp)
  - `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`
  - `FROM_EMAIL` / `FROM_NAME` - Sender details
  - `APP_URL` - Application URL for email links

### ğŸ“ File Structure (Phase 3)

```
src/modules/mailer/
â”œâ”€â”€ interfaces/
â”‚   â”œâ”€â”€ mail-options.interface.ts
â”‚   â””â”€â”€ mail-provider.interface.ts
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ ethereal.provider.ts
â”‚   â””â”€â”€ smtp.provider.ts
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ verification.hbs
â”‚   â”œâ”€â”€ password-reset.hbs
â”‚   â””â”€â”€ welcome.hbs
â”œâ”€â”€ processors/
â”‚   â””â”€â”€ mail.processor.ts
â”œâ”€â”€ mailer.service.ts
â””â”€â”€ mailer.module.ts
```

### ğŸ”— Integration
- âœ… `MailerModule` imported in `AppModule`
- âœ… BullMQ configured with Redis connection
- âœ… `MailerService` exported for use in `AuthModule` (Phase 4)

### âœ… Build Status
- âœ… TypeScript compilation: **Success**
- âœ… No linter errors
- âœ… All dependencies resolved

### âœ¨ Key Features Implemented

**Async Processing:**
- âœ… Emails queued via BullMQ, non-blocking
- âœ… Automatic retries with exponential backoff
- âœ… Concurrent processing for high throughput

**Provider Abstraction:**
- âœ… Easy switching between dev/prod providers
- âœ… Interface-based design for extensibility

**Template Engine:**
- âœ… Handlebars with responsive templates
- âœ… Variable substitution support

**Error Handling:**
- âœ… Retries, logging, graceful failures
- âœ… Job cleanup and monitoring

**Production Ready:**
- âœ… Redis-backed queue
- âœ… Configurable providers
- âœ… Environment-based configuration

---

## â³ Phase 4: Email Verification & Password Reset

**Status:** Not yet started

### 4.1 Email Verification Flow
- [ ] Update `register()` - set `isEmailVerified = false`, generate verification token
- [ ] Add `sendVerificationEmail()` to AuthService
- [ ] Create `POST /auth/verify` endpoint
- [ ] Create `POST /auth/resend-verification` endpoint
- [ ] Create `dto/verify-email.dto.ts`

### 4.2 Password Reset Flow
- [ ] Create `POST /auth/forgot-password` endpoint
- [ ] Create `POST /auth/reset-password` endpoint
- [ ] Implement token invalidation (single-use)
- [ ] Create `dto/password-reset.dto.ts`

---

## â³ Phase 5: Rate Limiting

**Status:** Not yet started

### 5.1 Rate Limiting Module
- [ ] Install `rate-limiter-flexible`
- [ ] Create rate limiting module, service, and guard
- [ ] Implement Redis-backed rate limiters

### 5.2 Apply Rate Limits
- [ ] Create `@RateLimit()` decorator
- [ ] Apply rate limits to auth endpoints

---

## â³ Phase 6: Observability & Monitoring

**Status:** Not yet started

### 6.1 Prometheus Metrics
- [ ] Add auth-specific metrics to PrometheusService

### 6.2 Structured Logging
- [ ] Add Pino logging in AuthService

### 6.3 Error Handling
- [ ] Create custom auth exceptions

---

## â³ Phase 7: Testing & Validation

**Status:** Not yet started

### 7.1 Unit Tests
- [ ] Test AuthService methods
- [ ] Test token utilities
- [ ] Test guards and decorators

### 7.2 Integration Tests
- [ ] Test registration flow end-to-end
- [ ] Test login flow with invalid credentials
- [ ] Test token refresh and rotation
- [ ] Test email verification flow

### 7.3 Security Tests
- [ ] Test refresh token reuse detection
- [ ] Test rate limiting blocks excessive requests
- [ ] Test password reset token single-use enforcement
- [ ] Test expired token rejection

### 7.4 Load Testing
- [ ] k6 script for `/auth/refresh` endpoint
- [ ] k6 script for `/auth/login` endpoint
- [ ] Monitor metrics during load tests

---

## â³ Phase 8: Documentation & Cleanup

**Status:** Not yet started

### 8.1 API Documentation
- [ ] Update Postman collection with auth endpoints
- [ ] Document request/response formats
- [ ] Add example curl commands

### 8.2 Code Documentation
- [ ] Add JSDoc comments to all public methods
- [ ] Document security considerations
- [ ] Add inline comments for complex logic

### 8.3 README Updates
- [ ] Update README with auth setup instructions
- [ ] Document environment variables
- [ ] Add troubleshooting section